version: "2.1"
services:
    ################################################################
    ###                   nginx services
    ###
    nginx:
        image: baykier/nginx:${NGINX_VERSION}
        environment:
            - DEVBOX_UID=${DEVBOX_UID}
            - DEVBOX_GID=${DEVBOX_GID}
        volumes_from:
            - "data-volume"
        volumes:
            - ./log/nginx:/var/log/nginx
            - ./conf/nginx:/etc/nginx/conf.d
        ports:
            - "80:80"
            - "443:443"
        links:
            - php-fpm-7.4
            - php-fpm-8.0
            - openface
        extra_hosts:
            # add extra hosts mapping for dev
            - "dev.devbox.dev:172.28.1.1"
        networks:
            devbox:
                ipv4_address: 172.28.1.1
        restart: always
    ##################################################################
    ###                 php services
    ### php-fpm-5.6
    php-fpm-5.6:
        image: baykier/php:5.6-wl
        volumes_from:
            - "data-volume"
        volumes:
            - ./log/php/php-fpm-5.6:/var/log/php
        environment:
            - DEVBOX_UID=${DEVBOX_UID}
            - DEVBOX_GID=${DEVBOX_GID}
        extra_hosts:
            - "dev.devbox.dev:172.28.1.1"
        links:
            - mysql-5.7
            - mongodb
            - redis
        networks:
            devbox:
                ipv4_address: 172.28.2.1
        restart: always
    ### php-fpm 7.4
    php-fpm-7.4:
        image: baykier/php:7.4-fpm
        volumes_from:
            - "data-volume"
        volumes:
            - ./log/php/php-fpm-7.4:/var/log/php
        environment:
            - DEVBOX_UID=${DEVBOX_UID}
            - DEVBOX_GID=${DEVBOX_GID}
        links:
            - mysql-5.7
            - redis
            #- xunsearch
        extra_hosts:
            - "dev.devbox.dev:172.28.1.1"
        networks:
            devbox:
                ipv4_address: 172.28.2.2
        restart: always
    ### php-fpm 8.0
    php-fpm-8.0:
        image: baykier/php:8.0-fpm
        volumes_from:
            - "data-volume"
        volumes:
            - ./log/php/php-fpm-8.0:/var/log/php
        environment:
            - DEVBOX_UID=${DEVBOX_UID}
            - DEVBOX_GID=${DEVBOX_GID}
        links:
            - mysql-5.7
            - mysql-8.0
            - redis
            #- xunsearch
        extra_hosts:
            - "dev.devbox.dev:172.28.1.1"
        networks:
            devbox:
                ipv4_address: 172.28.2.3
        restart: always
    ####################################################################
    ###                 database services
    ###
    mysql-5.7:
        image: baykier/mysql:5.7
        environment:
            - DEVBOX_UID=${DEVBOX_UID}
            - DEVBOX_GID=${DEVBOX_GID}
            - MYSQL_DATABASE=${DB_DATABASE}
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASSWORD}
            - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
        volumes:
            - ./data/mysql-5.7:/var/lib/mysql
            - ./log/mysql-5.7:/var/log/mysql
        ports:
            - "3306:3306"
        networks:
            devbox:
                ipv4_address: 172.28.3.1
        restart: always

    mysql-8.0:
        image: baykier/mysql:8.0
        environment:
            - MYSQL_DATABASE=${DB_DATABASE}
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASSWORD}
            - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
        volumes:
            - ./data/mysql-8.0:/var/lib/mysql
            - ./log/mysql-8.0:/var/log/mysql
        ports:
            - "3308:3306"
        networks:
            devbox:
                ipv4_address: 172.28.3.2
        restart: always

    ## postgres

    postgres-9.6:
        image: postgres:9.6.22-alpine
        environment:
            - POSTGRES_USER=root
            - POSTGRES_PASSWORD=root
        volumes:
            - ./data/postgresql:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        networks:
            devbox:
                ipv4_address: 172.28.3.3
        restart: always

    ## mongodb
    mongodb:
        image: mongo:4.2.0-bionic
        ports:
            - "27018:27017"
        networks:
            devbox:
                ipv4_address: 172.28.4.1
        restart: always

    ### Memcached
    memcached:
        build:
            context: ./build/memcached/1.5.4
        ports:
            - "11211:11211"
        networks:
            devbox:
                ipv4_address: 172.28.5.1
        restart: always
    ### Redis
    redis:
        build:
            context: ./build/redis/4.0
        ports:
            - "6379:6379"
        networks:
            devbox:
                ipv4_address: 172.28.6.1
        restart: always

    ### sshtunnel
    sshtunnel:
        image: baykier/sshtunnel
        environment:
            - BIND_LOCAL_HOST=0.0.0.0
            - BIND_LOCAL_PORT=3306
            - BIND_REMOTE_HOST=0.0.0.0
            - BIND_REMOTE_PORT=3306
            - SSH_SERVER_HOST=0.0.0.0
            - SSH_SERVER_PORT=22
            - SSH_USERNAME=sshtunnel
            - SSH_PASSPORD=sshtunnel
        restart: always
        networks:
            devbox:
                ipv4_address: 172.28.6.1

    #########################################################################################################
    ###              search engine services
    ### xunsearch
    xunsearch:
        image:  hightman/xunsearch
        ports:
            - "8383:8383"
            - "8384:8384"
        restart: always
        dns:
            - 114.114.114.114
            - 8.8.8.8
        networks:
            devbox:
                ipv4_address: 172.28.7.1

    ### elasticsearch
    elasticsearch:
        build:
            context: build/elk/elasticsearch/
            args:
                ELK_VERSION: ${ELK_VERSION}
        volumes:
            - ./build/elk/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
            - /usr/share/elasticsearch/data
        ports:
            - "9200:9200"
            - "9300:9300"
        environment:
            ES_JAVA_OPTS: "-Xmx256m -Xms256m"
            ELASTIC_PASSWORD: devbox
        logging:
            driver: "json-file"
            options:
                max-size: "200k"
                max-file: "10"
        networks:
            devbox:
                ipv4_address: 172.28.7.2
        restart: always
    ## logstash
    logstash:
        build:
            context: build/elk/logstash/
            args:
                ELK_VERSION: $ELK_VERSION
        volumes:
            - ./build/elk/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
            - ./build/elk/logstash/pipeline:/usr/share/logstash/pipeline:ro
        ports:
            - "5000:5000"
            - "9600:9600"
        environment:
            LS_JAVA_OPTS: "-Xmx256m -Xms256m"
        logging:
            driver: "json-file"
            options:
                max-size: "200k"
                max-file: "10"
        networks:
            devbox:
                    ipv4_address: 172.28.7.3
        restart: always
        depends_on:
            - elasticsearch
    ## kibana
    kibana:
        build:
            context: build/elk/kibana/
            args:
                ELK_VERSION: $ELK_VERSION
        volumes:
            - ./build/elk/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
        ports:
            - "5601:5601"
        networks:
            devbox:
                    ipv4_address: 172.28.7.4
        restart: always
        depends_on:
            - elasticsearch
    ## frp client
    frp-client:
        image: baykier:frp
        volumes:
            - ./conf/frp:/etc/frp

        environment:
            - FRP_SERVER_ADDR=1.1.1.1
            - FRP_SERVER_PORT=7000
            - FRP_LOCAL_ADDR=172.28.1.1
            - FRP_LOCAL_PORT=80
            - FRP_SUBDOMAIN=subdomain

        command:
            frpc -c /etc/frp/frpc.ini

        networks:
            devbox:
                ipv4_address: 172.28.8.1
        restart: always
    ########################################################################
    ##                    openface
    openface:
        image: baykier/openface:cgzdai
        volumes_from:
            - "data-volume"
        networks:
            devbox:
                ipv4_address: 172.28.9.1
        restart: always
    #####################################################################
    ###                     数据卷
    data-volume:
        image: tianon/true
        volumes:
            - /home/vagrant/projects:/project
            - ./log:/var/log
            - ./data:/var/data

networks:
    default:
        driver: bridge
        ipam:
            driver: default
            config:
                - subnet:  10.103.0.1/16   #避开192.168.20.0/24段
    devbox:
        ipam:
            driver: default
            config:
                - subnet: 172.28.0.0/16









